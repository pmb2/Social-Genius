FROM node:18-slim

WORKDIR /app

# Install dependencies required for Playwright and PostgreSQL
RUN apt-get update && apt-get install -y \
    libglib2.0-0 \
    libnss3 \
    libnspr4 \
    libatk1.0-0 \
    libatk-bridge2.0-0 \
    libcups2 \
    libdrm2 \
    libdbus-1-3 \
    libxcb1 \
    libxkbcommon0 \
    libx11-6 \
    libxcomposite1 \
    libxdamage1 \
    libxext6 \
    libxfixes3 \
    libxrandr2 \
    libgbm1 \
    libpango-1.0-0 \
    libcairo2 \
    libasound2 \
    libatspi2.0-0 \
    fonts-liberation \
    wget \
    xvfb \
    python3 \
    python3-pip \
    # PostgreSQL development library needed for compiling native modules
    postgresql-client \
    postgresql-common \
    libpq-dev \
    build-essential \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Copy package information
COPY package.json package-lock.json ./

# Disable native PostgreSQL modules
ENV NODE_PG_FORCE_NATIVE=0
ENV DEBUG_DATABASE=true
ENV PG_DEBUG=true

# Install dependencies without using native modules
RUN npm ci --ignore-scripts --legacy-peer-deps

# Make sure all Radix UI components are installed
RUN npm install --ignore-scripts @radix-ui/react-dropdown-menu @radix-ui/react-icons @radix-ui/react-dialog @radix-ui/react-slot @radix-ui/react-label @radix-ui/react-tabs

# Create a direct pg package without native bindings for more control
RUN mkdir -p /app/node_modules/pg-pure
COPY pg-patch.cjs /app/node_modules/pg-pure/
RUN echo 'module.exports = require("../../pg-patch.cjs");' > /app/node_modules/pg-pure/index.js

# Install Playwright browsers
RUN npx playwright install chromium
RUN npx playwright install-deps chromium

# Create directory for browser cookies
RUN mkdir -p /app/browser_cookies && chmod 777 /app/browser_cookies

# Copy source code
COPY . .

# Create .env.local file to override Next.js environment variables
RUN echo "NEXT_PUBLIC_DATABASE_URL=$DATABASE_URL" > .env.local
RUN echo "NEXT_PUBLIC_GROQ_API_KEY=$GROQ_API_KEY" >> .env.local
RUN echo "NEXT_PUBLIC_EXA_API_KEY=$EXA_API_KEY" >> .env.local
RUN echo "NEXT_PUBLIC_OPENAI_API_KEY=$OPENAI_API_KEY" >> .env.local

# Create and set permissions for temp directory (for PDF processing)
RUN mkdir -p /tmp && chmod 777 /tmp

# Set environment variables
ENV NODE_ENV=development
ENV PLAYWRIGHT_BROWSERS_PATH=/root/.cache/ms-playwright
ENV NEXT_TELEMETRY_DISABLED=1
ENV WATCHPACK_POLLING=true
ENV NODE_PG_FORCE_NATIVE=0
ENV RUNNING_IN_DOCKER=true

# Ensure Playwright browsers are properly installed and accessible
RUN chmod -R 755 /root/.cache/ms-playwright
RUN ls -la /root/.cache/ms-playwright

# Expose port
EXPOSE 3000

# Install pg modules without using native bindings
RUN npm install --ignore-scripts pg pg-pool

# Apply pg-patch and start the development server
CMD ["sh", "-c", "node pg-patch.cjs && node node_modules_patch.cjs && node fix-pg-pool.cjs && export NODE_OPTIONS='--max-old-space-size=4096' && npm run dev"]